<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tr·ª£ l√≠ Y t·∫ø</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"; }
    .scrollbar-thin { scrollbar-width: thin; }
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { border-radius: 8px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 min-h-screen">
<div class="max-w-5xl mx-auto p-4 sm:p-6">
  <!-- Header -->
  <header class="flex items-center justify-between gap-4 mb-4">
    <div><h1 class="text-2xl sm:text-3xl font-bold">Tr·ª£ l√≠ Y t·∫ø</h1></div>
    <div class="flex items-center gap-2">
      <input id="username" type="text" placeholder="T√™n c·ªßa b·∫°n" class="px-3 py-2 rounded-xl bg-white/80 dark:bg-slate-800 border focus:outline-none focus:ring focus:ring-indigo-500/30" />
      <button id="saveNameBtn" class="px-3 py-2 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-500">L∆∞u t√™n</button>
    </div>
  </header>

  <!-- Layout -->
  <div class="grid md:grid-cols-3 gap-4">
    <!-- Chat -->
    <section class="md:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border flex flex-col h-[72vh]">
      <div id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin"></div>
      <div class="border-t p-3">
        <div class="flex gap-2 items-end relative">
          <textarea id="userInput" rows="2" placeholder="B·∫°n mu·ªën h·ªèi g√¨?" class="flex-1 resize-none px-3 py-2 rounded-2xl bg-slate-50 dark:bg-slate-900 border focus:outline-none focus:ring focus:ring-indigo-500/30"></textarea>
          <button id="sendBtn" class="px-4 py-2 rounded-2xl bg-indigo-600 text-white font-semibold hover:bg-indigo-500">G·ª≠i</button>
          <button id="voiceBtn" class="px-4 py-2 rounded-2xl bg-rose-600 text-white font-semibold hover:bg-rose-500">üé§</button>

          <!-- Menu -->
          <div class="relative">
            <button id="moreBtn" class="px-4 py-2 rounded-2xl bg-slate-600 text-white font-semibold hover:bg-slate-500">‚ûï</button>
            <div id="moreMenu" class="hidden absolute bottom-12 right-0 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-lg border p-2 space-y-1">
              <button class="menuItem w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" data-action="upload">üìé Th√™m ·∫£nh & t·ªáp</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Appointment -->
    <aside class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border p-4 space-y-4 h-[72vh] overflow-y-auto scrollbar-thin">
      <div>
        <h2 class="font-semibold text-lg mb-2">L·ªãch h·∫πn c·ªßa t√¥i</h2>
        <div class="flex items-center gap-2 mb-2">
          <button id="refreshApptBtn" class="px-3 py-1.5 rounded-xl bg-slate-100 dark:bg-slate-700">T·∫£i l·ªãch</button>
        </div>
        <ul id="apptList" class="space-y-2"></ul>
      </div>
      <hr class="border-slate-200 dark:border-slate-700" />
      <div>
        <h2 class="font-semibold text-lg mb-2">ƒê·∫∑t l·ªãch nhanh</h2>
        <form id="bookForm" class="space-y-3">
          <div>
            <label class="block text-sm mb-1">Ph√≤ng kh√°m</label>
            <input id="clinic" type="text" required placeholder="VD: Ph√≤ng kh√°m ƒêa khoa ABC" class="w-full px-3 py-2 rounded-xl bg-slate-50 dark:bg-slate-900 border">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="date" class="block mb-2">Ng√†y kh√°m</label>
              <input type="date" id="date" class="w-full p-2 border rounded" required>
            </div>
            <div>
              <label for="time" class="block mb-2">Gi·ªù kh√°m</label>
              <input type="time" id="time" class="w-full p-2 border rounded" required>
            </div>
          </div>
          <button type="submit" class="w-full px-3 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-500">ƒê·∫∑t l·ªãch</button>
        </form>
      </div>
    </aside>
  </div>
</div>

<script>
const API_BASE = "https://trolyyte.onrender.com";
const chatHistory = document.getElementById('chatHistory');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const usernameEl = document.getElementById('username');
const saveNameBtn = document.getElementById('saveNameBtn');
const refreshApptBtn = document.getElementById('refreshApptBtn');
const apptList = document.getElementById('apptList');
const clinicEl = document.getElementById('clinic');
const dateEl = document.getElementById('date');
const timeEl = document.getElementById('time');
const bookForm = document.getElementById('bookForm');
const voiceBtn = document.getElementById('voiceBtn');
const moreBtn = document.getElementById('moreBtn');
const moreMenu = document.getElementById('moreMenu');

// cache t√™n
const persistedName = localStorage.getItem('health_username');
if (persistedName) usernameEl.value = persistedName;
saveNameBtn.addEventListener('click', () => {
  const name = usernameEl.value.trim();
  if (!name) return alert('Nh·∫≠p t√™n');
  localStorage.setItem('health_username', name);
  toast('ƒê√£ l∆∞u t√™n: ' + name);
});

// UI chat
function addMsg(role, text) {
  const wrap = document.createElement('div');
  wrap.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
  const bubble = document.createElement('div');
  bubble.className = `max-w-[85%] px-3 py-2 rounded-2xl shadow-sm border text-sm whitespace-pre-wrap ${
    role === 'user' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700'
  }`;
  bubble.innerHTML = marked.parse(text);
  wrap.appendChild(bubble);
  chatHistory.appendChild(wrap);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}
function toast(msg) {
  const t = document.createElement('div');
  t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-xl text-sm shadow-lg';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2200);
}

// --- Upload pending ---
let pendingFiles = [];
const hiddenFileInput = document.createElement("input");
hiddenFileInput.type = "file";
document.body.appendChild(hiddenFileInput);

hiddenFileInput.addEventListener("change", () => {
  if (!hiddenFileInput.files.length) return;
  const file = hiddenFileInput.files[0];
  pendingFiles = [file]; // ch·ªâ gi·ªØ file cu·ªëi
  addMsg("user", `üìé ƒê√£ ch·ªçn file: ${file.name} (s·∫Ω g·ª≠i khi b·∫°n b·∫•m G·ª≠i)`);
});

// --- Send message ---
async function sendMessage() {
  const name = (usernameEl.value || '').trim();
  const message = (userInput.value || '').trim();
  if (!name) return alert('Nh·∫≠p t√™n');
  if (!message && pendingFiles.length === 0) return;

  addMsg('user', message || '(G·ª≠i file)');
  userInput.value = '';

  try {
    let reply;
    if (pendingFiles.length > 0) {
      const formData = new FormData();
      formData.append("user", name);
      formData.append("message", message);
      formData.append("file", pendingFiles[0]);
      const res = await fetch(`${API_BASE}/api/message_with_file`, { method: "POST", body: formData });
      reply = (await res.json()).reply;
      pendingFiles = [];
    } else {
      const res = await fetch(`${API_BASE}/api/message`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username: name, message })
      });
      reply = (await res.json()).reply;
    }
    addMsg('assistant', reply);
  } catch (err) {
    console.error(err);
    addMsg('assistant', '‚ùå L·ªói k·∫øt n·ªëi backend');
  }
}
sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

// --- Appointment ---
async function loadAppointments() {
  const name = usernameEl.value.trim();
  if (!name) return alert('Nh·∫≠p t√™n');
  apptList.innerHTML = '<li>ƒêang t·∫£i...</li>';
  try {
    const res = await fetch(`${API_BASE}/api/appointments?user=${encodeURIComponent(name)}`);
    const data = await res.json();
    renderAppointments(data.appointments || []);
  } catch (e) { apptList.innerHTML = '<li class="text-rose-500">L·ªói t·∫£i l·ªãch</li>'; }
}
function renderAppointments(list) {
  apptList.innerHTML = '';
  if (!list.length) { apptList.innerHTML = '<li>Ch∆∞a c√≥ l·ªãch</li>'; return; }
  for (const a of list) {
    const li = document.createElement('li');
    li.className = 'p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border';
    li.innerHTML = `<div class="font-medium">${a.clinic}</div><div class="text-sm text-slate-500">${a.date} ${a.time}</div>`;
    apptList.appendChild(li);
  }
}
refreshApptBtn.addEventListener('click', loadAppointments);
bookForm.addEventListener('submit', async e => {
  e.preventDefault();
  const name = usernameEl.value.trim();
  if (!name) return alert('Nh·∫≠p t√™n');
  const payload = { user: name, clinic: clinicEl.value.trim(), date: dateEl.value.trim(), time: timeEl.value.trim() };
  try {
    const res = await fetch(`${API_BASE}/api/book`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    // ghi Google Sheet
    await fetch("https://script.google.com/macros/s/AKfycbzWE79uuLGZMV9PiyruPfj4tGzJH5ttiZKg-EYztZgADslNojf9Bh5N4uHhtTljksDB/exec", {
      method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload)
    });
    toast(data.message);
    clinicEl.value = ''; dateEl.value = ''; timeEl.value = '';
    loadAppointments();
  } catch (e) { alert('‚ùå ƒê·∫∑t l·ªãch th·∫•t b·∫°i'); }
});
if (persistedName) setTimeout(loadAppointments, 300);

// --- Voice ---
let recognition;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = "vi-VN";
  recognition.onresult = e => { userInput.value = e.results[0][0].transcript; sendMessage(); };
  recognition.onerror = e => { toast("L·ªói voice: " + e.error); toggleVoice(false); };
  recognition.onend = () => toggleVoice(false);
}
function toggleVoice(start) {
  if (!recognition) return;
  if (start) { recognition.start(); voiceBtn.textContent = "‚èπÔ∏è"; }
  else { recognition.stop(); voiceBtn.textContent = "üé§"; }
}
voiceBtn.addEventListener("click", () => { toggleVoice(voiceBtn.textContent==="üé§"); });

// menu
moreBtn.addEventListener("click", () => moreMenu.classList.toggle("hidden"));
document.querySelectorAll(".menuItem").forEach(item=>{
  item.addEventListener("click", ()=>{
    if(item.dataset.action==="upload") hiddenFileInput.click();
    moreMenu.classList.add("hidden");
  });
});
</script>
</body>
</html>
