<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tr·ª£ l√≠ Y t·∫ø</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, sans-serif; }
    .scrollbar-thin { scrollbar-width: thin; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #888; border-radius: 6px; }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="flex items-center justify-between gap-4 mb-4">
      <h1 class="text-2xl font-bold">Tr·ª£ l√≠ Y t·∫ø</h1>
      <div class="flex gap-2">
        <input id="username" type="text" placeholder="T√™n c·ªßa b·∫°n" class="px-3 py-2 rounded-lg border" />
        <button id="saveNameBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-lg">L∆∞u t√™n</button>
      </div>
    </header>

    <!-- Layout -->
    <div class="grid md:grid-cols-3 gap-4">
      <!-- Chat -->
      <section class="md:col-span-2 bg-white dark:bg-slate-800 rounded-2xl border flex flex-col h-[75vh]">
        <div id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin"></div>

        <!-- Input -->
        <div class="border-t p-3">
          <div class="flex gap-2 items-end">
            <textarea id="userInput" rows="2" placeholder="Nh·∫≠p c√¢u h·ªèi (Enter = g·ª≠i, Shift+Enter = xu·ªëng d√≤ng)" class="flex-1 resize-none px-3 py-2 rounded-xl border"></textarea>

            <!-- File upload -->
            <input type="file" id="fileInput" class="hidden" />
            <button id="fileBtn" class="px-3 py-2 rounded-xl bg-slate-200">üìé</button>

            <!-- Image upload -->
            <input type="file" id="imgInput" accept="image/*" class="hidden" />
            <button id="imgBtn" class="px-3 py-2 rounded-xl bg-slate-200">üì∑</button>

            <!-- Voice -->
            <button id="voiceBtn" class="px-3 py-2 rounded-xl bg-rose-600 text-white">üé§</button>

            <!-- Send -->
            <button id="sendBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">G·ª≠i</button>
          </div>
        </div>
      </section>

      <!-- Appointment -->
      <aside class="bg-white dark:bg-slate-800 rounded-2xl border p-4 space-y-4 h-[75vh] overflow-y-auto scrollbar-thin">
        <h2 class="font-semibold">L·ªãch h·∫πn</h2>
        <button id="refreshApptBtn" class="px-3 py-1 rounded-lg bg-slate-200">T·∫£i l·ªãch</button>
        <ul id="apptList" class="space-y-2"></ul>

        <hr class="my-2" />
        <h2 class="font-semibold">ƒê·∫∑t l·ªãch</h2>
        <form id="bookForm" class="space-y-2">
          <input id="clinic" type="text" placeholder="Ph√≤ng kh√°m" class="w-full px-3 py-2 rounded-lg border" required />
          <input id="date" type="date" class="w-full px-3 py-2 rounded-lg border" required />
          <input id="time" type="time" class="w-full px-3 py-2 rounded-lg border" required />
          <button type="submit" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-lg">ƒê·∫∑t l·ªãch</button>
        </form>
      </aside>
    </div>
  </div>

  <script>
    const API_BASE = "https://trolyyte-2.onrender.com";

    const chatHistory = document.getElementById("chatHistory");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const voiceBtn = document.getElementById("voiceBtn");
    const fileBtn = document.getElementById("fileBtn");
    const imgBtn = document.getElementById("imgBtn");
    const fileInput = document.getElementById("fileInput");
    const imgInput = document.getElementById("imgInput");
    const usernameEl = document.getElementById("username");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const apptList = document.getElementById("apptList");
    const refreshApptBtn = document.getElementById("refreshApptBtn");
    const bookForm = document.getElementById("bookForm");
    const clinicEl = document.getElementById("clinic");
    const dateEl = document.getElementById("date");
    const timeEl = document.getElementById("time");

    // Save/load username
    if (localStorage.getItem("health_username")) {
      usernameEl.value = localStorage.getItem("health_username");
    }
    saveNameBtn.addEventListener("click", () => {
      if (!usernameEl.value.trim()) return alert("Nh·∫≠p t√™n!");
      localStorage.setItem("health_username", usernameEl.value.trim());
      toast("ƒê√£ l∆∞u t√™n!");
    });

    // Enter to send
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener("click", sendMessage);

    // File & Image
    fileBtn.addEventListener("click", () => fileInput.click());
    imgBtn.addEventListener("click", () => imgInput.click());
    fileInput.addEventListener("change", handleFileUpload);
    imgInput.addEventListener("change", handleFileUpload);

    async function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      addMsg("user", "üìé ƒê√£ g·ª≠i t·ªáp: " + file.name);
      const formData = new FormData();
      formData.append("file", file);
      formData.append("user", usernameEl.value.trim());
      try {
        const res = await fetch(`${API_BASE}/api/upload`, { method: "POST", body: formData });
        const data = await res.json();
        addMsg("assistant", data.reply || "ƒê√£ nh·∫≠n t·ªáp.");
      } catch {
        addMsg("assistant", "L·ªói t·∫£i t·ªáp.");
      }
    }

    function addMsg(role, text) {
      const wrap = document.createElement("div");
      wrap.className = `flex ${role === "user" ? "justify-end" : "justify-start"}`;
      const bubble = document.createElement("div");
      bubble.className = `px-3 py-2 rounded-xl border max-w-[80%] whitespace-pre-wrap ${role === "user" ? "bg-indigo-600 text-white" : "bg-slate-100"}`;
      bubble.innerHTML = marked.parse(text);
      wrap.appendChild(bubble);
      chatHistory.appendChild(wrap);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function sendMessage() {
      const name = usernameEl.value.trim();
      const msg = userInput.value.trim();
      if (!name) return alert("Nh·∫≠p t√™n tr∆∞·ªõc!");
      if (!msg) return;
      addMsg("user", msg);
      userInput.value = "";
      try {
        const res = await fetch(`${API_BASE}/api/message`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: name, message: msg }),
        });
        const data = await res.json();
        addMsg("assistant", data.reply || "");
      } catch {
        addMsg("assistant", "L·ªói g·ªçi API.");
      }
    }

    // Appointments
    refreshApptBtn.addEventListener("click", loadAppointments);
    async function loadAppointments() {
      const name = usernameEl.value.trim();
      if (!name) return alert("Nh·∫≠p t√™n!");
      apptList.innerHTML = "<li>ƒêang t·∫£i...</li>";
      try {
        const res = await fetch(`${API_BASE}/api/appointments?user=${encodeURIComponent(name)}`);
        const data = await res.json();
        apptList.innerHTML = "";
        if (!data.appointments.length) return (apptList.innerHTML = "<li>Kh√¥ng c√≥ l·ªãch h·∫πn</li>");
        data.appointments.forEach(a => {
          const li = document.createElement("li");
          li.className = "p-2 rounded bg-slate-100";
          li.innerHTML = `${a.clinic} - ${a.date} ${a.time}`;
          apptList.appendChild(li);
        });
      } catch { apptList.innerHTML = "<li>L·ªói t·∫£i l·ªãch</li>"; }
    }

    bookForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        user: usernameEl.value.trim(),
        clinic: clinicEl.value.trim(),
        date: dateEl.value,
        time: timeEl.value,
      };
      try {
        const res = await fetch(`${API_BASE}/api/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        toast("ƒê·∫∑t l·ªãch th√†nh c√¥ng!");
        loadAppointments();
      } catch { toast("ƒê·∫∑t l·ªãch th·∫•t b·∫°i!"); }
    });

    function toast(msg) {
      const t = document.createElement("div");
      t.className = "fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded";
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2000);
    }

    // Voice Recognition
    if ("webkitSpeechRecognition" in window) {
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "vi-VN";
      recognition.onresult = e => { userInput.value += e.results[0][0].transcript; };
      recognition.onstart = () => voiceBtn.textContent = "üéôÔ∏è...";
      recognition.onend = () => voiceBtn.textContent = "üé§";
      voiceBtn.addEventListener("click", () => recognition.start());
    } else {
      voiceBtn.style.display = "none";
    }
  </script>
</body>
</html>
